generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  firstName     String
  lastName      String
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  isMfaEnabled  Boolean   @default(false)
  deletedAt     DateTime?

  role   UserRole      @default(CONSUMER)
  status AccountStatus @default(ACTIVE)

  accounts         Account[]
  sessions         Session[]
  mfaDevices       MfaDevice[]
  recoveryCodes    RecoveryCode[]
  teamMembers      TeamMember[]
  teamInvitations  TeamInvitation[]
  createdEndpoints Endpoint[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([deletedAt])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  ipAddress String?
  userAgent String?

  country       String?
  countryCode   String?
  continent     String?
  continentCode String?
  region        String?
  regionCode    String?
  city          String?
  latitude      Float?
  longitude     Float?
  postalCode    String?
  timezone      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([token])
}

model MfaDevice {
  id     String @id @default(cuid())
  userId String
  name   String
  secret String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model RecoveryCode {
  id     String  @id @default(cuid())
  userId String
  code   String
  isUsed Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, code])
  @@index([userId])
}

model Team {
  id    String  @id @default(cuid())
  name  String
  slug  String  @unique
  image String?

  members     TeamMember[]
  invitations TeamInvitation[]
  projects    Project[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

model TeamMember {
  id     String   @id @default(cuid())
  teamId String
  userId String
  role   TeamRole @default(MEMBER)

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model TeamInvitation {
  id        String           @id @default(cuid())
  teamId    String
  email     String
  role      TeamRole         @default(MEMBER)
  token     String           @unique
  status    InvitationStatus @default(PENDING)
  expiresAt DateTime

  invitedBy String

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [invitedBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([email])
  @@index([token])
}

model Project {
  id     String @id @default(cuid())
  name   String
  slug   String
  teamId String

  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  endpoints Endpoint[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, slug])
  @@index([teamId])
  @@index([slug])
}

model Endpoint {
  id          String  @id @default(cuid())
  name        String
  slug        String
  description String?
  projectId   String
  createdBy   String

  framework String
  inputType InputType @default(JSON)

  // Deployment source type
  deploymentType DeploymentType @default(SINGLE_FILE)

  // Single file deployment (legacy)
  gcsModelPath        String?
  gcsRequirementsPath String?
  gcsInferencePath    String?

  // ZIP archive deployment
  gcsArchivePath String?

  // GitHub repository deployment
  gitRepoUrl    String?
  gitBranch     String?
  gitCommitSha  String?
  gitAccessToken String? // Encrypted token for private repos

  imageUri   String?
  serviceUrl String?

  apiKey String @unique @default(cuid())

  accessType EndpointAccessType @default(PRIVATE)

  status EndpointStatus @default(UPLOADING)

  inputTokenPrice  Decimal? @db.Decimal(10, 6)
  outputTokenPrice Decimal? @db.Decimal(10, 6)

  pricePerRequest Decimal? @db.Decimal(10, 4)

  errorMessage String? @db.Text
  buildLogs    String? @db.Text
  deployedAt   DateTime?
  lastUsedAt   DateTime?

  project  Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator  User       @relation(fields: [createdBy], references: [id])
  apiUsage ApiUsage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, slug])
  @@index([projectId])
  @@index([slug])
  @@index([status])
  @@index([apiKey])
  @@index([createdBy])
  @@index([accessType])
  @@index([deploymentType])
}

model ApiUsage {
  id         String @id @default(cuid())
  endpointId String

  method       String
  path         String
  statusCode   Int
  responseTime Int 

  inputTokens  Int? 
  outputTokens Int?

  apiKey    String?
  ipAddress String?
  userAgent String?

  cost Decimal? @db.Decimal(10, 6)

  endpoint Endpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  timestamp DateTime @default(now())

  @@index([endpointId])
  @@index([timestamp])
  @@index([apiKey])
}

enum UserRole {
  ADMIN
  DEVELOPER
  CONSUMER
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  BLOCKED
  PENDING
  INACTIVE
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELLED
}

enum EndpointAccessType {
  PUBLIC  
  PRIVATE 
  PAID    
}

enum EndpointStatus {
  UPLOADING
  BUILDING
  DEPLOYING
  DEPLOYED
  FAILED
  SUSPENDED
}

enum InputType {
  JSON      // JSON array/object input [[1,2,3]]
  IMAGE     // Image file (PNG, JPG, etc.) - base64 encoded
  TEXT      // Plain text input
  AUDIO     // Audio file (MP3, WAV, etc.)
  VIDEO     // Video file (MP4, AVI, etc.)
  FILE      // Generic file upload
}

enum DeploymentType {
  SINGLE_FILE     // Legacy: single model file + requirements.txt
  ZIP_ARCHIVE     // ZIP file containing model + dependencies + custom code
  GIT_REPOSITORY  // GitHub/GitLab repository
}
